<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spring & Autumn Overlay (wld)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    #opacityBox {
      position: absolute; left: 12px; top: 12px; z-index: 9999;
      background: rgba(255,255,255,0.9); padding: 8px 12px; border-radius: 10px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans";
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
    }
    #toast {
      position: absolute; left: 12px; bottom: 12px; z-index: 9999;
      background: rgba(0,0,0,.75); color: #fff; padding: 8px 12px; border-radius: 8px;
      font-size: 14px; max-width: 520px;
    }
    /* 让灰底图半透明，突出地形 */
    .graybase { opacity: .45; }
  </style>
</head>
<body>
  <div id="opacityBox">
    Overlay opacity：
    <input id="opacity" type="range" min="0" max="1" step="0.05" value="0.75">
  </div>
  <div id="map"></div>
  <div id="toast">完成。若看不到图，请滚轮缩放一次；叠加区会有红色边框。</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ------------------ 地图 ------------------
    const map = L.map('map', {
      center: [34.5, 108.9],
      zoom: 5,
      zoomControl: true
    });

    // 1) Esri World Hillshade —— 仅地形阴影，无标签（推荐做主底图）
    const hillshade = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.esri.com/">Esri</a> | Esri World Hillshade'
      }
    ).addTo(map);

    // 2) Esri Light Gray Base —— 无标签灰底（轻描岸线/线框，搭配 hillshade 更清晰）
    const grayBase = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        className: 'graybase',
        attribution: '&copy; Esri | World Light Gray Base'
      }
    ).addTo(map);

    // ------------------ 读取 wld + PNG 并叠加 ------------------
    const pngUrl = 'EN-LateSpringAutumn_modified.png';
    const wldUrl = 'EN-LateSpringAutumn_modified.wld';

    // 兼容 GitHub Pages 对 wld 的 MIME：强制 arrayBuffer+解码
    async function readText(url) {
      const r = await fetch(url + '?v=' + Date.now());
      if (!r.ok) throw new Error(`Fetch ${url} failed: ${r.status}`);
      const buf = await r.arrayBuffer();
      return new TextDecoder('utf-8').decode(buf);
    }

    function parsewld(text) {
      // world file: 6 行数字 A,B,D,E,C,F
      const nums = text.trim().split(/[\r\n]+/).map(s => parseFloat(s));
      if (nums.length !== 6 || nums.some(n => Number.isNaN(n))) {
        throw new Error('wld 解析失败：需要 6 行数字');
      }
      const [A, B, D, E, C, F] = nums; // A,B,D,E,C,F
      return { A, B, D, E, C, F };
    }

    function waitImageSize(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve({ width: img.naturalWidth, height: img.naturalHeight });
        img.onerror = () => reject(new Error('PNG 加载失败: ' + url));
        img.src = url + '?v=' + Date.now();
      });
    }

    (async () => {
      try {
        // 1) 读 wld
        const wldText = await readText(wldUrl);
        const { A, B, D, E, C, F } = parsewld(wldText);

        // 2) PNG 尺寸
        const { width: W, height: H } = await waitImageSize(pngUrl);

        // 3) 计算四角（在源投影 EPSG:3857 的平面坐标）
        // 公式：X = C + A*x + B*y；Y = F + D*x + E*y，x∈[0..W]，y∈[0..H]
        const corners3857 = [
          [C + A*0   + B*0  , F + D*0   + E*0  ], // 左上
          [C + A*W   + B*0  , F + D*W   + E*0  ], // 右上
          [C + A*W   + B*H  , F + D*W   + E*H  ], // 右下
          [C + A*0   + B*H  , F + D*0   + E*H  ]  // 左下
        ];

        // 4) 转成经纬度（Leaflet 需要 LatLng）。地图是 EPSG:3857 -> 用 unproject
        const cornersLatLng = corners3857.map(([x, y]) =>
          L.CRS.EPSG3857.unproject(L.point(x, y))
        );
        const bounds = L.latLngBounds(cornersLatLng);

        // 5) 叠加 PNG
        const overlay = L.imageOverlay(pngUrl, bounds, { opacity: 0.75, interactive: false }).addTo(map);

        // 6) 红色边框（对齐检查用）
        L.polyline([...cornersLatLng, cornersLatLng[0]], {
          color: '#e74c3c', weight: 2, opacity: 0.9
        }).addTo(map);

        // 7) 视图聚焦
        map.fitBounds(bounds.pad(0.05));

        // 8) 透明度控制
        document.getElementById('opacity').addEventListener('input', e => {
          overlay.setOpacity(parseFloat(e.target.value));
        });

        // 移除提示
        setTimeout(() => { const t = document.getElementById('toast'); if (t) t.remove(); }, 3500);
      } catch (err) {
        console.error(err);
        alert('叠加失败：' + err.message);
      }
    })();
  </script>
</body>
</html>

